<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SkyWay - Room example</title>
    <style>
        video {width: 0; height: 0;}
    </style>
</head>

<body>
    <video id="js-local-stream"></video>
    <span id="js-room-mode"></span>:
    <input type="text" placeholder="Room Name" id="js-room-id">
    <button id="js-join-trigger">Join</button>
    <button id="js-leave-trigger">Leave</button>
    <div class="remote-streams" id="js-remote-streams"></div>
    <pre class="messages" id="js-messages"></pre>

    <script src="//cdn.webrtc.ecl.ntt.com/skyway-4.4.1.js"></script>
    <script>
        const Peer = window.Peer;
        (async function main() {
            const localVideo = document.getElementById('js-local-stream');
            const joinTrigger = document.getElementById('js-join-trigger');
            const leaveTrigger = document.getElementById('js-leave-trigger');
            const remoteVideos = document.getElementById('js-remote-streams');
            const roomId = document.getElementById('js-room-id');
            const roomMode = document.getElementById('js-room-mode');
            const messages = document.getElementById('js-messages');

            const getRoomModeByHash = () => (location.hash === '#sfu' ? 'sfu' : 'sfu');

            roomMode.textContent = getRoomModeByHash();
            window.addEventListener(
                'hashchange',
                () => (roomMode.textContent = getRoomModeByHash())
            );

            const localStream = await navigator.mediaDevices
                .getUserMedia({
                    audio: true,
                    video: false,
                }).catch(console.error);

            localVideo.muted = true;
            localVideo.srcObject = localStream;
            localVideo.playsInline = false;
            await localVideo.play().catch(console.error);

            const peer = (window.peer = new Peer({
                key: '7fb74053-4689-485c-900e-6ceb33be1b56',
                debug: 3,
            }));

            
            joinTrigger.addEventListener('click', () => {
                if (!peer.open) {
                    return;
                }
                const room = peer.joinRoom(roomId.value, {
                    mode: getRoomModeByHash(),
                    stream: localStream,
                });
                room.once('open', () => {
                    messages.textContent += '=== You joined ===\n';
                });
                room.on('peerJoin', peerId => {
                    messages.textContent += `=== ${peerId} joined ===\n`;
                });
                room.on('stream', async stream => {
                    const newVideo = document.createElement('video');
                    newVideo.srcObject = stream;
                    newVideo.playsInline = true;
                    // mark peerId to find it later at peerLeave event
                    newVideo.setAttribute('data-peer-id', stream.peerId);
                    remoteVideos.append(newVideo);
                    await newVideo.play().catch(console.error);
                });
                room.on('data', ({ data, src }) => {
                    // Show a message sent to the room and who sent
                    messages.textContent += `${src}: ${data}\n`;
                });
                room.on('peerLeave', peerId => {
                    const remoteVideo = remoteVideos.querySelector(
                        `[data-peer-id="${peerId}"]`
                    );
                    remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                    remoteVideo.srcObject = null;
                    remoteVideo.remove();

                    messages.textContent += `=== ${peerId} left ===\n`;
                });
                room.once('close', () => {
                    messages.textContent += '== You left ===\n';
                    Array.from(remoteVideos.children).forEach(remoteVideo => {
                        remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                        remoteVideo.srcObject = null;
                        remoteVideo.remove();
                    });
                });
                leaveTrigger.addEventListener('click', () => room.close(), { once: true });
            });

            peer.on('error', console.error);
        })();

        const rid = document.getElementById('js-room-id');

        firebase.database().ref(SVR).set(rid)
    </script>
</body>

</html>

<!-- 7fb74053-4689-485c-900e-6ceb33be1b56 -->